<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        html {
            font-family: monospace
        }

        .logElement {
            float: left;
            overflow: auto;
            border: 1px solid black;
            padding: 10px;
            margin: 10px;
            max-height: 400px;
            min-width: 300px;
        }

        .logElement ul {
            padding-left: 0px;
            margin-left: 5px;
        }

    </style>
</head>

<body>
    <div>
        <div class="logElement">
            <h2>Client</h2>
            <ul id="clientLog">
            </ul>
        </div>

        <div class="logElement">
            <h2>Drone</h2>
            <ul id="droneLog">
            </ul>
        </div>
    </div>

    <script type="text/javascript">
        class KeyPressMonitor {
            constructor() {
                this.keyDownSet = new Set();
            }

            keyDown(keyCode, callIfInitialKeyDown) {
                if (!this.keyDownSet.has(keyCode)) {
                    callIfInitialKeyDown();
                    this.keyDownSet.add(keyCode);
                }
            }

            keyUp(keyCode) {
                this.keyDownSet.delete(keyCode);
            }
        }

        const protocol = window.location.href.startsWith("https") ?
            "wss" :
            "ws";
        const url = protocol + ":" + window.location.hostname + ":" + window.location.port;

        window.onload = function (e) {
            console.log("started");
            var clientLogElement = document.getElementById("clientLog");
            var droneLogElement = document.getElementById("droneLog");

            var appendLog = function(message, logElement) {
                logElement.insertAdjacentHTML('beforeend', '<li>' + message + '</li>');
                parentElement = logElement.parentElement;
                parentElement.scrollTo(0, parentElement.scrollHeight);
            };

            var socketClientOut = new WebSocket(url);
            socketClientOut.onopen = function (event) {
                appendLog("connection opened", clientLogElement);
            };
            socketClientOut.onmessage = function (event) {
                appendLog("Received: " + event.data, clientLogElement);
            };


            var socketDroneIn = new WebSocket(url);
            socketDroneIn.onopen = function (event) {
                appendLog("drone in connection opened", droneLogElement);
            };
            socketDroneIn.onmessage = function (event) {
                appendLog("Received: " + event.data, droneLogElement);
            };

            const keyPressMonitor = new KeyPressMonitor();

            document.onkeydown = function(evt) {
                evt = evt || window.event;
                var keyCode = (typeof evt.which == "number") ? evt.which : evt.keyCode;

                if (keyCode) {
                    keyPressMonitor.keyDown(keyCode, function() {
                        socketClientOut.send(JSON.stringify({
                                keyCode: keyCode,
                                delta: "down"
                            }));
                    });
                }
            };

            document.onkeyup = function(evt) {
                evt = evt || window.event;
                var keyCode = (typeof evt.which == "number") ? evt.which : evt.keyCode;

                if (keyCode) {
                    keyPressMonitor.keyUp(keyCode);
                    socketClientOut.send(JSON.stringify({
                            keyCode: keyCode,
                            delta: "up"
                        }));
                }
            };
        };
    </script>
</body>
</html>
